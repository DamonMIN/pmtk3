
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML is auto-generated from an M-file.
To make changes, update the M-file and republish this document.
      --><title>cancerRatesMh</title><meta name="generator" content="MATLAB 7.9"><meta name="date" content="2010-02-25"><meta name="m-file" content="cancerRatesMh"><style type="text/css">

body {
  background-color: white;
  margin:10px;
}

h1 {
  color: #990000; 
  font-size: x-large;
}

h2 {
  color: #990000;
  font-size: medium;
}

/* Make the text shrink to fit narrow windows, but not stretch too far in 
wide windows. */ 
p,h1,h2,div.content div {
  max-width: 600px;
  /* Hack for IE6 */
  width: auto !important; width: 600px;
}

pre.codeinput {
  background: #EEEEEE;
  padding: 10px;
}
@media print {
  pre.codeinput {word-wrap:break-word; width:100%;}
} 

span.keyword {color: #0000FF}
span.comment {color: #228B22}
span.string {color: #A020F0}
span.untermstring {color: #B20000}
span.syscmd {color: #B28C00}

pre.codeoutput {
  color: #666666;
  padding: 10px;
}

pre.error {
  color: red;
}

p.footer {
  text-align: right;
  font-size: xx-small;
  font-weight: lighter;
  font-style: italic;
  color: gray;
}

  </style></head><body><div class="content"><h2>Contents</h2><div><ul><li><a href="#1">Hierarchical Bayesian Estimation of Some Binomial Proportions</a></li><li><a href="#3">Hyper parameters</a></li><li><a href="#4">MCMC</a></li><li><a href="#5">Diagnostics</a></li><li><a href="#6">Posterior means and CI</a></li><li><a href="#7">Plot</a></li></ul></div><h2>Hierarchical Bayesian Estimation of Some Binomial Proportions<a name="1"></a></h2><pre class="codeinput"><span class="keyword">function</span> cancerRatesMh()
</pre><pre class="codeinput"><span class="comment">% Johnson and Albert  p67</span>
<span class="comment">% mhDemoJohnsonHierBino C:\kmurphy\pmtkLocal\BLTold\PMLcode\Book</span>

<span class="comment">% data p24</span>
data.y = [0 0 2 0 1 1 0 2 1 3 0 1 1 1 54 0 0 1 3 0];
data.n = [1083 855 3461 657 1208 1025 527 1668 583 582 917 857 <span class="keyword">...</span>
    680 917 53637 874 395 581 588 383];
</pre><h2>Hyper parameters<a name="3"></a></h2><pre class="codeinput">hparams.am = 0.01;
hparams.bm = 9.99; <span class="comment">% JA p25 says 9.9, but then prior precision is not 10</span>

xinit = 0.1*randn(1,2); <span class="comment">% initial state</span>
<span class="comment">%map = fminunc(@target, xinit)</span>

<span class="comment">%{
</span><span class="comment">%% Exact inference on a grid
</span><span class="comment">%xrange = -7:0.1:-5; yrange = 4:0.1:10;
</span><span class="comment">xrange = -15:0.01:0; yrange = -10:0.01:10;
</span><span class="comment">[xs, ys] = meshgrid(xrange, yrange);
</span><span class="comment">xy = [xs(:)'; ys(:)']';
</span><span class="comment">logp = target(xy);
</span><span class="comment">%p = exp(normalizeLogspace(logp));
</span><span class="comment">p = logp;
</span><span class="comment">p = reshape(p, size(xs));
</span><span class="comment">h = max(p(:));
</span><span class="comment">%vals = [0.1*h 0.01*h 0.001*h];
</span><span class="comment">
</span><span class="comment">
</span><span class="comment">figContour = figure; contour(xs(1,:), ys(:,1), p);
</span><span class="comment">xlabel('logit(m)'); ylabel('log(K)')
</span><span class="comment">
</span><span class="comment">figImagesc = figure; imagesc(p); colorbar
</span><span class="comment">set(gca, 'xticklabel', xrange(get(gca,'xtick')))
</span><span class="comment">set(gca, 'yticklabel', yrange(get(gca,'ytick')))
</span><span class="comment">axis xy; xlabel('logit(m)'); ylabel('log(K)')
</span><span class="comment">%}</span>
</pre><h2>MCMC<a name="4"></a></h2><pre class="codeinput">Nsamples = 5000;
burnin = 500;
SigmaProp = 0.3*eye(2); <span class="comment">% if smaller, accept rate gets too high</span>
setSeed(1);
model = struct(<span class="string">'mu'</span>, zeros(1, 2), <span class="string">'Sigma'</span>, SigmaProp);
proposal = @(x) (x + gaussSample(model));

[x, acceptRatio] = metropolisHastings(@target, proposal, xinit, Nsamples, burnin);
</pre><pre class="codeoutput">Warning: Divide by zero. This warning will be removed in a
future release.
         Consider using DBSTOP IF NANINF when debugging. 
</pre><h2>Diagnostics<a name="5"></a></h2><p>trace plot</p><pre class="codeinput">figure;
plot(x(:,1), <span class="string">'r-'</span>);
hold <span class="string">on</span>
plot(x(:,2), <span class="string">'b:'</span>);
title(sprintf(<span class="string">'red=logitM, blue=logK, accept rate = %5.3f'</span>, acceptRatio));

samples.m = sigmoid(x(:,1));
samples.K = exp(x(:,2));
samples.logitm = x(:, 1);
samples.logK = x(:, 2);

<span class="comment">% plot of posterior</span>
figure;plot(samples.logitm, samples.logK, <span class="string">'.'</span>);
xlabel(<span class="string">'logit(m)'</span>); ylabel(<span class="string">'log(K)'</span>)
<span class="comment">%axis ij</span>

<span class="comment">%figure(figContour); hold on;</span>
plot(samples.logitm, samples.logK, <span class="string">'k.'</span>, <span class="string">'markersize'</span>, 12);
line(samples.logitm(1:10:end), samples.logK(1:10:end), <span class="string">'marker'</span>,<span class="string">'o'</span>,<span class="string">'linestyle'</span>,<span class="string">'none'</span>);




<span class="comment">%figure;plot(samples.m, samples.K, '.')</span>
<span class="comment">%xlabel('m'); ylabel('K')</span>
</pre><img vspace="5" hspace="5" src="cancerRatesMh_01.png" alt=""> <img vspace="5" hspace="5" src="cancerRatesMh_02.png" alt=""> <h2>Posterior means and CI<a name="6"></a></h2><pre class="codeinput">d = length(data.n); <span class="comment">% ncities;</span>
samples.theta = zeros(Nsamples, d);
post.meantheta = zeros(d,1); post.CItheta = zeros(d, 2);
<span class="keyword">for</span> i=1:d
   thetaMLE(i) = data.y(i)/data.n(i);
  as = data.y(i) + samples.K .* samples.m;
  bs = data.n(i) - data.y(i) + samples.K .* (1-samples.m);
  samples.theta(:,i) = betarnd(as, bs);
  post.meantheta(i) = mean(samples.theta(:,i));
  post.CItheta(i,:) = quantile(samples.theta(:,i), [0.025 0.975]);
  post.mediantheta(i) = quantile(samples.theta(:,i), [0.5]);
<span class="keyword">end</span>
thetaPooledMLE = sum(data.y)/sum(data.n);
</pre><h2>Plot<a name="7"></a></h2><pre class="codeinput">figure;
subplot(4,1,1); bar(data.y); title(<span class="string">'number of people with cancer (truncated at 5)'</span>)
set(gca,<span class="string">'ylim'</span>,[0 5])
subplot(4,1,2); bar(data.n); title(<span class="string">'pop of city (truncated at 2000)'</span>);
set(gca,<span class="string">'ylim'</span>,[0 2000])
subplot(4,1,3); bar(thetaMLE);title(<span class="string">'MLE'</span>);
subplot(4,1,4); bar(post.meantheta);title(<span class="string">'posterior mean (red line=pooled MLE)'</span>)
hold <span class="string">on</span>;h=line([0 20], [thetaPooledMLE thetaPooledMLE]);
set(h,<span class="string">'color'</span>,<span class="string">'r'</span>,<span class="string">'linewidth'</span>,2)

<span class="comment">% 95% credible interval</span>
figure; hold <span class="string">on</span>;
<span class="keyword">for</span> i=1:d
  q = post.CItheta(i,1:2);
  h = line([q(1) q(2)], [i i]);
  median = post.mediantheta(i);
  h=plot(median,i,<span class="string">'*'</span>);
<span class="keyword">end</span>
title(<span class="string">'95% credible interval on theta, *=median'</span>)



  <span class="keyword">function</span> logp = target(x)
    logitM = x(:,1); logK = x(:,2);
    m = sigmoid(logitM); K = exp(logK);
    ncases = length(data.n);
    logp = (hparams.am-1).*log(m) + (hparams.bm-1).*log(1-m) <span class="keyword">...</span>
      -2*log(1+K) + sum(betaln(K'*m+data.y, K'*(1-m)+data.n-data.y)) <span class="keyword">...</span>
      -ncases*betaln(K'*m, K'*(1-m));
  <span class="keyword">end</span>
</pre><img vspace="5" hspace="5" src="cancerRatesMh_03.png" alt=""> <img vspace="5" hspace="5" src="cancerRatesMh_04.png" alt=""> <pre class="codeinput"><span class="keyword">end</span>
</pre><p class="footer"><br>
      Published with MATLAB&reg; 7.9<br></p></div><!--
##### SOURCE BEGIN #####
%% Hierarchical Bayesian Estimation of Some Binomial Proportions
function cancerRatesMh()
% Johnson and Albert  p67
% mhDemoJohnsonHierBino C:\kmurphy\pmtkLocal\BLTold\PMLcode\Book

% data p24
data.y = [0 0 2 0 1 1 0 2 1 3 0 1 1 1 54 0 0 1 3 0];
data.n = [1083 855 3461 657 1208 1025 527 1668 583 582 917 857 ...
    680 917 53637 874 395 581 588 383];


%% Hyper parameters
hparams.am = 0.01;
hparams.bm = 9.99; % JA p25 says 9.9, but then prior precision is not 10

xinit = 0.1*randn(1,2); % initial state
%map = fminunc(@target, xinit)

%{
%% Exact inference on a grid
%xrange = -7:0.1:-5; yrange = 4:0.1:10;
xrange = -15:0.01:0; yrange = -10:0.01:10;
[xs, ys] = meshgrid(xrange, yrange);
xy = [xs(:)'; ys(:)']';
logp = target(xy);
%p = exp(normalizeLogspace(logp));
p = logp;
p = reshape(p, size(xs));
h = max(p(:));
%vals = [0.1*h 0.01*h 0.001*h];


figContour = figure; contour(xs(1,:), ys(:,1), p);
xlabel('logit(m)'); ylabel('log(K)')

figImagesc = figure; imagesc(p); colorbar
set(gca, 'xticklabel', xrange(get(gca,'xtick')))
set(gca, 'yticklabel', yrange(get(gca,'ytick')))
axis xy; xlabel('logit(m)'); ylabel('log(K)')
%}


%% MCMC 
Nsamples = 5000;   
burnin = 500;
SigmaProp = 0.3*eye(2); % if smaller, accept rate gets too high     
setSeed(1); 
model = struct('mu', zeros(1, 2), 'Sigma', SigmaProp);
proposal = @(x) (x + gaussSample(model));

[x, acceptRatio] = metropolisHastings(@target, proposal, xinit, Nsamples, burnin);

%% Diagnostics
% trace plot
figure;
plot(x(:,1), 'r-');
hold on
plot(x(:,2), 'b:');
title(sprintf('red=logitM, blue=logK, accept rate = %5.3f', acceptRatio));

samples.m = sigmoid(x(:,1));
samples.K = exp(x(:,2));
samples.logitm = x(:, 1);
samples.logK = x(:, 2);

% plot of posterior
figure;plot(samples.logitm, samples.logK, '.');
xlabel('logit(m)'); ylabel('log(K)')
%axis ij

%figure(figContour); hold on;
plot(samples.logitm, samples.logK, 'k.', 'markersize', 12);
line(samples.logitm(1:10:end), samples.logK(1:10:end), 'marker','o','linestyle','none');


      

%figure;plot(samples.m, samples.K, '.')
%xlabel('m'); ylabel('K')


%% Posterior means and CI
d = length(data.n); % ncities;
samples.theta = zeros(Nsamples, d);
post.meantheta = zeros(d,1); post.CItheta = zeros(d, 2);
for i=1:d
   thetaMLE(i) = data.y(i)/data.n(i);
  as = data.y(i) + samples.K .* samples.m;
  bs = data.n(i) - data.y(i) + samples.K .* (1-samples.m);
  samples.theta(:,i) = betarnd(as, bs);
  post.meantheta(i) = mean(samples.theta(:,i));
  post.CItheta(i,:) = quantile(samples.theta(:,i), [0.025 0.975]);
  post.mediantheta(i) = quantile(samples.theta(:,i), [0.5]);
end
thetaPooledMLE = sum(data.y)/sum(data.n);

%% Plot
figure;
subplot(4,1,1); bar(data.y); title('number of people with cancer (truncated at 5)')
set(gca,'ylim',[0 5])
subplot(4,1,2); bar(data.n); title('pop of city (truncated at 2000)');
set(gca,'ylim',[0 2000])
subplot(4,1,3); bar(thetaMLE);title('MLE');
subplot(4,1,4); bar(post.meantheta);title('posterior mean (red line=pooled MLE)')
hold on;h=line([0 20], [thetaPooledMLE thetaPooledMLE]);
set(h,'color','r','linewidth',2)

% 95% credible interval
figure; hold on;
for i=1:d
  q = post.CItheta(i,1:2);
  h = line([q(1) q(2)], [i i]);
  median = post.mediantheta(i);
  h=plot(median,i,'*');
end
title('95% credible interval on theta, *=median')



  function logp = target(x)
    logitM = x(:,1); logK = x(:,2);
    m = sigmoid(logitM); K = exp(logK);
    ncases = length(data.n);
    logp = (hparams.am-1).*log(m) + (hparams.bm-1).*log(1-m) ...
      -2*log(1+K) + sum(betaln(K'*m+data.y, K'*(1-m)+data.n-data.y)) ...
      -ncases*betaln(K'*m, K'*(1-m));
  end


end

##### SOURCE END #####
--></body></html>