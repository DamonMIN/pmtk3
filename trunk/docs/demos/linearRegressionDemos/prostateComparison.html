
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML is auto-generated from an M-file.
To make changes, update the M-file and republish this document.
      --><title>prostateComparison</title><meta name="generator" content="MATLAB 7.9"><meta name="date" content="2010-02-25"><meta name="m-file" content="prostateComparison"><style type="text/css">

body {
  background-color: white;
  margin:10px;
}

h1 {
  color: #990000; 
  font-size: x-large;
}

h2 {
  color: #990000;
  font-size: medium;
}

/* Make the text shrink to fit narrow windows, but not stretch too far in 
wide windows. */ 
p,h1,h2,div.content div {
  max-width: 600px;
  /* Hack for IE6 */
  width: auto !important; width: 600px;
}

pre.codeinput {
  background: #EEEEEE;
  padding: 10px;
}
@media print {
  pre.codeinput {word-wrap:break-word; width:100%;}
} 

span.keyword {color: #0000FF}
span.comment {color: #228B22}
span.string {color: #A020F0}
span.untermstring {color: #B20000}
span.syscmd {color: #B28C00}

pre.codeoutput {
  color: #666666;
  padding: 10px;
}

pre.error {
  color: red;
}

p.footer {
  text-align: right;
  font-size: xx-small;
  font-weight: lighter;
  font-style: italic;
  color: gray;
}

  </style></head><body><div class="content"><h2>Contents</h2><div><ul><li><a href="#2">Compare L1, L2, allSubsets, and OLS linear regression on the prostate data set</a></li><li><a href="#3">All subsets</a></li><li><a href="#5">for plotting purposes, look at fewer subsets</a></li><li><a href="#6">OLS</a></li></ul></div><pre class="codeinput"><span class="keyword">function</span> prostateComparison()
</pre><h2>Compare L1, L2, allSubsets, and OLS linear regression on the prostate data set<a name="2"></a></h2><p>Reproduced table 3.3 and fig 3.7 on p63 of "Elements of statistical learning" 2e</p><pre class="codeinput">saveLatex = false;
setSeed(1);
mse = zeros(4, 1);
weights = zeros(9, 4);

data = load(<span class="string">'prostate.mat'</span>);
data.X = mkUnitVariance(center(data.X));
<span class="comment">%data.y = center(data.y);</span>
data.Xtrain = data.X(data.istrain, :);
data.Xtest  = data.X(~data.istrain, :);
standardizeData  = false; <span class="comment">% no need to do this inside CV</span>

fitFns        = {@(X, y, lambda)linregFitL1(X, y, lambda, <span class="string">'lars'</span>, standardizeData), <span class="keyword">...</span>
                 @(X, y, lambda)linregFitL2(X, y, lambda, <span class="string">'QR'</span>, standardizeData)};

predictFn     =  @linregPredict;
lossFn        =  @(yhat, ytest)mean((yhat - ytest).^2);
lambdas       =  logspace(2, 0, 30);
figureNames   = {<span class="string">'prostateLassoCV'</span>, <span class="string">'prostateRidgeCV'</span>};
titlePrefixes = {<span class="string">'lasso'</span>, <span class="string">'ridge'</span>};
nfolds = 10;
useLogScale = true;

<span class="keyword">for</span> i=1:numel(fitFns);
    [model, lambdaStar, mu, se] = <span class="keyword">...</span>
        fitCv(lambdas, fitFns{i}, predictFn, lossFn, data.Xtrain, data.ytrain, nfolds);
    figure;
    plotCVcurve(lambdas(end:-1:1), mu, se, lambdaStar, useLogScale);
    xlabel(<span class="string">'lambda value'</span>);
    yhat = linregPredict(model, data.Xtest);
    mse(i) = lossFn(yhat, data.ytest);
    title(sprintf(<span class="string">'%s, mseTest = %5.3f'</span>, titlePrefixes{i}, mse(i)));
    printPmtkFigure(figureNames{i});
    weights(:, i) = [model.w0; colvec(model.w)];
<span class="keyword">end</span>
</pre><img vspace="5" hspace="5" src="prostateComparison_01.png" alt=""> <img vspace="5" hspace="5" src="prostateComparison_02.png" alt=""> <h2>All subsets<a name="3"></a></h2><pre class="codeinput">    <span class="keyword">function</span> model = fitFn(X, y, ndx)
       [N,D] = size(X);
       include = ndx{:};
       exclude = setdiff(1:D, include);
       X(:, exclude) = 0;
       lambda = eps; <span class="comment">% needed to avoid numerical issues caused by 0 entries in X</span>
       model = linregFitL2(X, y, lambda, <span class="string">'QR'</span>, false);
    <span class="keyword">end</span>
</pre><pre class="codeinput">d = size(data.Xtrain, 2);
ss = powerset(1:d); <span class="comment">% 256 models</span>
[modelFull, bestNdx] = <span class="keyword">...</span>
        fitCv(ss, @fitFn, predictFn, lossFn, data.Xtrain, data.ytrain, nfolds);
ssStarFull = ss{bestNdx};
</pre><h2>for plotting purposes, look at fewer subsets<a name="5"></a></h2><pre class="codeinput">ssSmall = {[], 1, 1:2, 1:3, 1:4, 1:5, 1:6, 1:7, 1:8};
[model, ssStarNdx, mu, se] = <span class="keyword">...</span>
        fitCv(ssSmall, @fitFn, predictFn, lossFn, data.Xtrain, data.ytrain, nfolds);
ssStarNdx = ssStarNdx-1;    <span class="comment">% -1 since we are counting from size = 0</span>
<span class="comment">%ssStarNdx = cellfind(ssSmall, ssStar) - 1;</span>
useLogScale = false;
figure;
plotCVcurve(0:8, mu, se, ssStarNdx, useLogScale); <span class="comment">% plot w.r.t to subset sizes</span>
xlabel(<span class="string">'subset size'</span>);
yhat = linregPredict(modelFull, data.Xtest);
mse(3) = lossFn(yhat, data.ytest);
t = {  sprintf(<span class="string">'%s, mseTest = %5.3f'</span>, <span class="string">'all subsets'</span>, mse(3));
       [<span class="string">'best subset = '</span>, mat2str(ssStarFull)]
    };
title(t);
printPmtkFigure(<span class="string">'prostateSubsetsCV'</span>);

weights(:, 3) = [modelFull.w0; colvec(modelFull.w)];
</pre><img vspace="5" hspace="5" src="prostateComparison_03.png" alt=""> <h2>OLS<a name="6"></a></h2><pre class="codeinput">model = linregFit(data.Xtrain, data.ytrain);
weights(:, 4) = [model.w0; colvec(model.w)];
yhat = linregPredict(model, data.Xtest);
mse(4) = lossFn(yhat, data.ytest);
</pre><pre class="codeinput">fprintf(<span class="string">'| OLS | SS | L2 | L1 |\n'</span>);
fprintf(<span class="string">'weights: \n'</span>);
display(roundto(weights(:, end:-1:1), 0.001));
fprintf(<span class="string">'mse: \n'</span>);
display(roundto(mse(end:-1:1), 0.001));
</pre><pre class="codeoutput">| OLS | SS | L2 | L1 |
weights: 
ans =
    2.4520    2.4810    2.4790    2.4800
    0.7160    0.6510    0.6560    0.6530
    0.2930    0.3800    0.3000    0.2970
   -0.1430         0   -0.1290   -0.1190
    0.2120         0    0.2080    0.2000
    0.3100         0    0.3010    0.2890
   -0.2890         0   -0.2600   -0.2360
   -0.0210         0   -0.0190         0
    0.2770    0.1780    0.2560    0.2260
mse: 
ans =
    0.5860
    0.5720
    0.5800
    0.5640
</pre><pre class="codeinput"><span class="keyword">if</span> saveLatex
   weights = weights(:, end:-1:1);
   mse = mse(end:-1:1);
   headers = {<span class="string">'Term'</span>, <span class="string">'LS'</span>, <span class="string">'Best Subset'</span>, <span class="string">'Ridge'</span>, <span class="string">'Lasso'</span>};
   terms = [{<span class="string">'Intercept'</span>}, data.names(1:8), {<span class="string">'Test Error'</span>}]';
   table = [cell(10, 1), num2cell([weights; rowvec(mse)])];
   latextable(table, <span class="string">'Horiz'</span>, headers, <span class="string">'Vert'</span>, terms, <span class="string">'format'</span>, <span class="string">'%.3f'</span>, <span class="string">'Hline'</span>, [1, 10]);
<span class="keyword">end</span>
</pre><pre class="codeinput"><span class="keyword">end</span>
</pre><p class="footer"><br>
      Published with MATLAB&reg; 7.9<br></p></div><!--
##### SOURCE BEGIN #####
function prostateComparison() 
%% Compare L1, L2, allSubsets, and OLS linear regression on the prostate data set
% Reproduced table 3.3 and fig 3.7 on p63 of "Elements of statistical learning" 2e


saveLatex = false;
setSeed(1);
mse = zeros(4, 1); 
weights = zeros(9, 4);

data = load('prostate.mat');
data.X = mkUnitVariance(center(data.X));
%data.y = center(data.y);
data.Xtrain = data.X(data.istrain, :); 
data.Xtest  = data.X(~data.istrain, :);
standardizeData  = false; % no need to do this inside CV

fitFns        = {@(X, y, lambda)linregFitL1(X, y, lambda, 'lars', standardizeData), ...
                 @(X, y, lambda)linregFitL2(X, y, lambda, 'QR', standardizeData)};
                
predictFn     =  @linregPredict;
lossFn        =  @(yhat, ytest)mean((yhat - ytest).^2);
lambdas       =  logspace(2, 0, 30);
figureNames   = {'prostateLassoCV', 'prostateRidgeCV'};
titlePrefixes = {'lasso', 'ridge'};
nfolds = 10;
useLogScale = true; 

for i=1:numel(fitFns);
    [model, lambdaStar, mu, se] = ...
        fitCv(lambdas, fitFns{i}, predictFn, lossFn, data.Xtrain, data.ytrain, nfolds);
    figure;
    plotCVcurve(lambdas(end:-1:1), mu, se, lambdaStar, useLogScale); 
    xlabel('lambda value');
    yhat = linregPredict(model, data.Xtest); 
    mse(i) = lossFn(yhat, data.ytest);
    title(sprintf('%s, mseTest = %5.3f', titlePrefixes{i}, mse(i)));
    printPmtkFigure(figureNames{i});
    weights(:, i) = [model.w0; colvec(model.w)]; 
end
%% All subsets
    function model = fitFn(X, y, ndx)    
       [N,D] = size(X);
       include = ndx{:};
       exclude = setdiff(1:D, include);
       X(:, exclude) = 0;
       lambda = eps; % needed to avoid numerical issues caused by 0 entries in X
       model = linregFitL2(X, y, lambda, 'QR', false); 
    end
%%    
d = size(data.Xtrain, 2); 
ss = powerset(1:d); % 256 models
[modelFull, bestNdx] = ...
        fitCv(ss, @fitFn, predictFn, lossFn, data.Xtrain, data.ytrain, nfolds);
ssStarFull = ss{bestNdx};

%% for plotting purposes, look at fewer subsets
ssSmall = {[], 1, 1:2, 1:3, 1:4, 1:5, 1:6, 1:7, 1:8};
[model, ssStarNdx, mu, se] = ...
        fitCv(ssSmall, @fitFn, predictFn, lossFn, data.Xtrain, data.ytrain, nfolds);
ssStarNdx = ssStarNdx-1;    % -1 since we are counting from size = 0
%ssStarNdx = cellfind(ssSmall, ssStar) - 1;
useLogScale = false; 
figure;
plotCVcurve(0:8, mu, se, ssStarNdx, useLogScale); % plot w.r.t to subset sizes
xlabel('subset size');
yhat = linregPredict(modelFull, data.Xtest); 
mse(3) = lossFn(yhat, data.ytest);
t = {  sprintf('%s, mseTest = %5.3f', 'all subsets', mse(3)); 
       ['best subset = ', mat2str(ssStarFull)]
    };
title(t);
printPmtkFigure('prostateSubsetsCV');

weights(:, 3) = [modelFull.w0; colvec(modelFull.w)];
%% OLS
model = linregFit(data.Xtrain, data.ytrain);
weights(:, 4) = [model.w0; colvec(model.w)];
yhat = linregPredict(model, data.Xtest);
mse(4) = lossFn(yhat, data.ytest); 
%%
fprintf('| OLS | SS | L2 | L1 |\n');
fprintf('weights: \n');
display(roundto(weights(:, end:-1:1), 0.001));
fprintf('mse: \n'); 
display(roundto(mse(end:-1:1), 0.001));
%%
if saveLatex
   weights = weights(:, end:-1:1); 
   mse = mse(end:-1:1);
   headers = {'Term', 'LS', 'Best Subset', 'Ridge', 'Lasso'};
   terms = [{'Intercept'}, data.names(1:8), {'Test Error'}]';
   table = [cell(10, 1), num2cell([weights; rowvec(mse)])];
   latextable(table, 'Horiz', headers, 'Vert', terms, 'format', '%.3f', 'Hline', [1, 10]); 
end

end
##### SOURCE END #####
--></body></html>